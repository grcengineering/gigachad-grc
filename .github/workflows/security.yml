name: Security

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC for continuous monitoring
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '20'

jobs:
  # Static Application Security Testing (SAST)
  sast:
    name: SAST Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/typescript
            p/nodejs
            p/react
            .semgrep/
        env:
          SEMGREP_RULES: >-
            p/security-audit
            p/secrets
            p/typescript
            p/nodejs
            p/react

      - name: Upload SARIF results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
        continue-on-error: true

  # Secret Detection
  secrets:
    name: Secret Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Full history for scanning

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: true

      - name: Run TruffleHog (additional secret detection)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified
        continue-on-error: true # TruffleHog is supplementary

  # Dependency Vulnerability Scanning
  dependencies:
    name: Dependency Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit (blocking on high/critical)
        run: |
          echo "## Dependency Audit Results" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=high 2>&1 | tee audit-results.txt
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::npm audit found high or critical vulnerabilities"
            echo "❌ High/Critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            cat audit-results.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "✅ No high/critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY

      - name: Check for known vulnerable packages
        run: |
          # Check for packages with known severe vulnerabilities
          VULNERABLE_PACKAGES="lodash@<4.17.21 minimist@<1.2.6 node-fetch@<2.6.7 axios@<0.21.2"
          for pkg in $VULNERABLE_PACKAGES; do
            if npm ls "$pkg" 2>/dev/null | grep -q "$pkg"; then
              echo "::error::Found vulnerable package: $pkg"
              exit 1
            fi
          done

  # Container Security Scanning
  container:
    name: Container Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        service: [controls, frameworks, policies, tprm, trust, audit]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/${{ matrix.service }}/Dockerfile
          push: false
          load: true
          tags: grc-${{ matrix.service }}:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max
        continue-on-error: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'grc-${{ matrix.service }}:scan'
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1' # BLOCKING: Fail on critical/high vulnerabilities
          ignore-unfixed: true
        continue-on-error: false

      - name: Upload Trivy scan results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-${{ matrix.service }}.sarif'
          category: 'trivy-${{ matrix.service }}'
        continue-on-error: true

  # Infrastructure as Code Security
  iac:
    name: IaC Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Checkov on Terraform
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,checkov-terraform.sarif
          soft_fail: false # BLOCKING: Fail on IaC misconfigurations
          skip_check: CKV_AWS_144,CKV_AWS_145 # Skip specific checks if needed
        continue-on-error: false

      - name: Run Checkov on Docker Compose
        uses: bridgecrewio/checkov-action@v12
        with:
          file: docker-compose.yml
          framework: dockerfile
          output_format: cli
          soft_fail: false
        continue-on-error: true # Docker Compose checks are advisory

      - name: Upload Checkov SARIF results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-terraform.sarif
          category: 'checkov-terraform'
        continue-on-error: true

  # License Compliance Check
  licenses:
    name: License Compliance
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check licenses
        run: |
          npx license-checker --production --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;CC0-1.0;Unlicense;0BSD;CC-BY-3.0;CC-BY-4.0;Python-2.0;BlueOak-1.0.0" --excludePrivatePackages || {
            echo "::warning::Some packages have non-standard licenses. Please review."
            exit 0  # Warning only, not blocking
          }

  # CodeQL Analysis (GitHub's native SAST)
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [javascript-typescript]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: '/language:${{ matrix.language }}'

  # Security Summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [sast, secrets, dependencies, container, iac, licenses, codeql]
    if: always()

    steps:
      - name: Check all security jobs
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST (Semgrep) | ${{ needs.sast.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Detection | ${{ needs.secrets.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependencies.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Scan | ${{ needs.container.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| IaC Security | ${{ needs.iac.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Compliance | ${{ needs.licenses.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | ${{ needs.codeql.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine overall status
          if [ "${{ needs.sast.result }}" == "failure" ] || \
             [ "${{ needs.secrets.result }}" == "failure" ] || \
             [ "${{ needs.dependencies.result }}" == "failure" ] || \
             [ "${{ needs.container.result }}" == "failure" ] || \
             [ "${{ needs.iac.result }}" == "failure" ]; then
            echo "❌ **Security checks failed. PR cannot be merged.**" >> $GITHUB_STEP_SUMMARY
            echo ""
            echo "::error::One or more security checks failed. Please review the findings above."
            exit 1
          fi

          echo "✅ **All security checks passed.**" >> $GITHUB_STEP_SUMMARY
